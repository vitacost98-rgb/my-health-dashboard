<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¥åº·ç®¡ç†å„€è¡¨æ¿ - ç¶œåˆæ•¸æ“šæ•´åˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        // --- [é‡è¦è¨­å®šå€] ---
        // 1. è«‹ç¢ºèªæ­¤ ID çµå°¾ç‚º .apps.googleusercontent.com
        const CLIENT_ID = '107140118174-mm7cbcacd1evj72plq2b9pm6f1gf9fk4.apps.googleusercontent.com'; 
        // 2. ğŸš¨ æ‚¨å¿…é ˆåœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Gemini API Key æ‰èƒ½åŸ·è¡Œåˆ†æåŠŸèƒ½
        const API_KEY = ""; 
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly';
        // ------------------

        const PROJECT_NUMBER = CLIENT_ID.split('-')[0];
        let tokenClient;
        let accessToken = null;
        let calChart;

        let currentDayData = {
            date: "",
            fileId: null,
            consumed: { cal: 0, pro: 0, carb: 0, fat: 0 },
            targets: { cal: 2000, pro: 120, carb: 150, fat: 60 },
            contexts: { plan: "", note: "", history: "" }
        };

        // --- Google API åˆå§‹åŒ–ä¿®å¾© ---
        function gapiLoaded() {
            gapi.load('client:picker', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                    console.log("GAPI è¼‰å…¥æˆåŠŸ");
                } catch (e) { console.error("GAPI Error:", e); }
            });
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    ux_mode: 'popup', 
                    callback: (resp) => {
                        if (resp.error) {
                            console.error("Auth Error:", resp);
                            alert("æˆæ¬Šå¤±æ•—ï¼š" + resp.error);
                            return;
                        }
                        accessToken = resp.access_token;
                        document.getElementById('auth-btn').innerHTML = `<i class="fas fa-check-circle"></i> é›²ç«¯å·²é€£ç·š`;
                        document.getElementById('auth-btn').classList.replace('bg-blue-600', 'bg-emerald-600');
                        loadDailyData();
                    },
                });
                console.log("GIS è¼‰å…¥æˆåŠŸ");
            } catch (e) { console.error("GIS Error:", e); }
        }

        function handleAuthClick() {
            if (!tokenClient) {
                // è‹¥ tokenClient å°šæœªåˆå§‹åŒ–ï¼Œå˜—è©¦æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡ (è™•ç†è…³æœ¬è¼‰å…¥é †åºå•é¡Œ)
                if (typeof google !== 'undefined' && google.accounts) {
                    gisLoaded();
                    alert("èªè­‰æ¨¡çµ„å˜—è©¦é‡å•Ÿä¸­ï¼Œè«‹å†æŒ‰ä¸€æ¬¡ã€‚");
                } else {
                    alert("Google è…³æœ¬å°šæœªè¼‰å…¥å®Œç•¢ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢ã€‚");
                }
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        // --- é›²ç«¯æ•¸æ“šåŒæ­¥ ---
        async function loadDailyData() {
            const dateStr = document.getElementById('target-date').value;
            if (!dateStr) return;
            currentDayData.date = dateStr;
            showLoading(true, `åŒæ­¥é›²ç«¯æ—¥èªŒ...`);
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name = 'HealthLog_${dateStr}.json' and trashed = false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    currentDayData.fileId = files[0].id;
                    const content = await gapi.client.drive.files.get({ fileId: currentDayData.fileId, alt: 'media' });
                    const rawData = typeof content.body === 'string' ? JSON.parse(content.body) : content.result;
                    currentDayData.consumed = rawData.consumed || currentDayData.consumed;
                } else {
                    currentDayData.fileId = null;
                    currentDayData.consumed = { cal: 0, pro: 0, carb: 0, fat: 0 };
                }
                updateUI();
                renderThinking(`<b>ç³»çµ±è¨Šæ¯ï¼š</b><br>åŒæ­¥æˆåŠŸï¼ç›®å‰æ—¥æœŸï¼š${dateStr}ã€‚æ‚¨å¯ä»¥é–‹å§‹åŒ¯å…¥æª”æ¡ˆæˆ–é€²è¡Œåˆ†æã€‚`);
            } catch (err) { 
                console.error(err);
                renderThinking(`<b>åŒæ­¥å¤±æ•—ï¼š</b><br>ç„¡æ³•è®€å–é›²ç«¯æ—¥èªŒï¼Œè«‹ç¢ºèªæ˜¯å¦æœ‰ Drive API æ¬Šé™ã€‚`);
            }
            finally { showLoading(false); }
        }

        async function saveDailyData() {
            if (!accessToken) return;
            const fileData = JSON.stringify(currentDayData);
            try {
                if (currentDayData.fileId) {
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${currentDayData.fileId}?uploadType=media`, {
                        method: 'PATCH', headers: { 'Authorization': `Bearer ${accessToken}` }, body: fileData
                    });
                } else {
                    const metadata = { name: `HealthLog_${currentDayData.date}.json`, mimeType: 'application/json' };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([fileData], { type: 'application/json' }));
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}` }, body: form
                    });
                }
            } catch (err) { console.error("å„²å­˜å¤±æ•—", err); }
        }

        // --- æª”æ¡ˆè™•ç†é‚è¼¯ ---

        function triggerLocalFile(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.txt,.html,.htm,.pdf,.doc,.docx';
            input.onchange = (e) => handleLocalFiles(e.target.files, type);
            input.click();
        }

        async function handleLocalFiles(files, type) {
            showLoading(true, `æ­£åœ¨è®€å–æœ¬åœ°æª”æ¡ˆ...`);
            let totalContent = "";
            let fileNames = [];

            for (const file of files) {
                fileNames.push(file.name);
                const content = await readFileAsTextOrBase64(file);
                totalContent += `\n--- æœ¬åœ°æª”æ¡ˆï¼š${file.name} ---\n${content}\n`;
            }

            currentDayData.contexts[type] = (currentDayData.contexts[type] || "") + totalContent;
            
            const badge = document.createElement('div');
            badge.className = "bg-blue-500/20 p-2 rounded-lg text-[10px] mt-1 text-blue-400 border border-blue-500/30 flex flex-col gap-1";
            badge.innerHTML = `
                <div class="flex justify-between items-center font-bold">
                    <span><i class="fas fa-desktop mr-1"></i> å·²åŒ¯å…¥ ${files.length} å€‹æœ¬åœ°æª”æ¡ˆ</span>
                    <i class="fas fa-check text-emerald-400"></i>
                </div>
                <div class="text-[9px] opacity-70 italic">${fileNames.join(', ')}</div>
            `;
            
            const container = document.getElementById('selected-contexts');
            const existing = container.querySelector(`[data-type="${type}-local"]`);
            if (existing) existing.remove();
            badge.setAttribute('data-type', `${type}-local`);
            container.appendChild(badge);
            
            renderThinking(`æˆåŠŸè¼‰å…¥æœ¬åœ°æª”æ¡ˆï¼š<b>${fileNames.join(', ')}</b>ã€‚`);
            showLoading(false);
        }

        function readFileAsTextOrBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                if (file.type === "text/plain" || file.type === "text/html") {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsText(file);
                } else {
                    reader.onload = (e) => resolve(`[æª”æ¡ˆå…§å®¹æ‘˜è¦: ${file.name}]`);
                    reader.readAsDataURL(file);
                }
            });
        }

        function createPicker(type) {
            if (!accessToken) return alert("è«‹å…ˆé€£çµ Google å¸³è™Ÿ");
            const mimes = ['application/vnd.google-apps.document','text/plain','application/pdf','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/msword'].join(',');
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS).setMimeTypes(mimes);
            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                .setAppId(PROJECT_NUMBER).setOAuthToken(accessToken).addView(view)
                .setCallback((data) => pickerCallback(data, type)).build();
            picker.setVisible(true);
        }

        async function pickerCallback(data, type) {
            if (data.action === google.picker.Action.PICKED) {
                showLoading(true, `æ­£åœ¨å¾é›²ç«¯åŒ¯å…¥å¤šå€‹æª”æ¡ˆ...`);
                try {
                    let totalContent = "";
                    let fileNames = [];
                    for (const doc of data.docs) {
                        fileNames.push(doc.name);
                        let content = "";
                        if (doc.mimeType === 'application/vnd.google-apps.document') {
                            const exportUrl = `https://www.googleapis.com/drive/v3/files/${doc.id}/export?mimeType=text/plain`;
                            const response = await fetch(exportUrl, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                            content = await response.text();
                        } else {
                            const getUrl = `https://www.googleapis.com/drive/v3/files/${doc.id}?alt=media`;
                            const response = await fetch(getUrl, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                            content = await response.text();
                        }
                        totalContent += `\n--- é›²ç«¯æª”æ¡ˆï¼š${doc.name} ---\n${content}\n`;
                    }
                    currentDayData.contexts[type] = (currentDayData.contexts[type] || "") + totalContent;
                    
                    const badge = document.createElement('div');
                    badge.className = "bg-emerald-500/20 p-2 rounded-lg text-[10px] mt-1 text-emerald-400 border border-emerald-500/30 flex flex-col gap-1";
                    badge.innerHTML = `
                        <div class="flex justify-between items-center font-bold">
                            <span><i class="fas fa-cloud mr-1"></i> å·²åŒ¯å…¥ ${data.docs.length} å€‹é›²ç«¯æª”æ¡ˆ</span>
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="text-[9px] opacity-70 italic">${fileNames.join(', ')}</div>
                    `;
                    
                    const container = document.getElementById('selected-contexts');
                    const existing = container.querySelector(`[data-type="${type}-cloud"]`);
                    if (existing) existing.remove();
                    badge.setAttribute('data-type', `${type}-cloud`);
                    container.appendChild(badge);
                    
                    renderThinking(`é›²ç«¯æª”æ¡ˆåŒ¯å…¥å®Œæˆï¼š<b>${fileNames.join(', ')}</b>ã€‚`);
                } catch (e) { console.error(e); }
                finally { showLoading(false); }
            }
        }

        // --- AI åŸ·è¡ŒåŠŸèƒ½ (å«æŒ‡æ•¸é€€é¿æ©Ÿåˆ¶) ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                    if (response.status === 401) throw new Error("API Key ç„¡æ•ˆæˆ–å·²éæœŸ");
                    if (response.status !== 429 && response.status < 500) break;
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                }
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
            throw new Error("ç„¡æ³•é€£çµ AI ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚");
        }

        async function processIntake() {
            if (!API_KEY) {
                alert("ğŸš¨ å°šæœªå¡«å¯« API_KEYï¼è«‹åœ¨ç¨‹å¼ç¢¼ç¬¬ 15 è¡Œå¡«å…¥æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
                return;
            }

            const foodImg = document.getElementById('food-img').files[0];
            const mealFile = document.getElementById('meal-file').files[0];
            const mealText = document.getElementById('meal-text-input').value;
            
            const mVals = {
                cal: parseFloat(document.getElementById('manual-cal').value) || 0,
                pro: parseFloat(document.getElementById('manual-pro').value) || 0,
                carb: parseFloat(document.getElementById('manual-carb').value) || 0,
                fat: parseFloat(document.getElementById('manual-fat').value) || 0
            };

            // å¦‚æœä»€éº¼éƒ½æ²’è¼¸å…¥å‰‡æé†’
            if (!foodImg && !mealFile && !mealText && Object.values(mVals).every(v => v === 0)) {
                alert("è«‹è‡³å°‘æä¾›ç…§ç‰‡ã€æè¿°æ–‡å­—æˆ–æ•¸å€¼å…¶ä¸­ä¹‹ä¸€ã€‚");
                return;
            }

            showLoading(true, "Gemini æ­£åœ¨åˆ†ææ•¸æ“š...");
            
            try {
                let mealFileContent = "";
                if (mealFile) {
                    mealFileContent = await readFileAsTextOrBase64(mealFile);
                }

                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­ç‡Ÿé¤Šå¸«ã€‚è«‹åˆ†ææœ¬æ¬¡æ”å–å…§å®¹ã€‚
                èƒŒæ™¯è„ˆçµ¡ï¼š${JSON.stringify(currentDayData.contexts)}
                ä»Šæ—¥å·²æ”å–ï¼š${JSON.stringify(currentDayData.consumed)}
                æ–‡å­—æè¿°ï¼š${mealText}
                æ‰‹å‹•è¼¸å…¥æ•¸å€¼ï¼š${JSON.stringify(mVals)}
                æª”æ¡ˆé™„åŠ è³‡è¨Šï¼š${mealFileContent}
                è«‹ç¶œåˆä»¥ä¸Šè³‡è¨Šï¼ˆåŒ…å«åœ–ç‰‡èˆ‡æª”æ¡ˆï¼‰ï¼Œä¼°è¨ˆç†±é‡ã€è›‹ç™½è³ªã€ç¢³æ°´ã€è„‚è‚ªã€‚
                è«‹å‹™å¿…åš´æ ¼å›å‚³ JSON æ ¼å¼ï¼š{"cal": æ•¸å€¼, "pro": æ•¸å€¼, "carb": æ•¸å€¼, "fat": æ•¸å€¼, "advice": "é‡å° Mounjaro éšæ®µèˆ‡ä»£è¬çš„å°ˆæ¥­å»ºè­°"}`;

                const parts = [{ text: prompt }];
                if (foodImg) {
                    const base64 = await toBase64(foodImg);
                    parts.push({ inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } });
                }

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });

                if (!data.candidates) throw new Error("AI æœªèƒ½ç”¢å‡ºæœ‰æ•ˆçµæœï¼Œå¯èƒ½æ˜¯ API é™åˆ¶æˆ–å…§å®¹é•è¦ã€‚");

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                const jsonMatch = text.match(/\{.*\}/s);
                
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    currentDayData.consumed.cal += (result.cal || 0);
                    currentDayData.consumed.pro += (result.pro || 0);
                    currentDayData.consumed.carb += (result.carb || 0);
                    currentDayData.consumed.fat += (result.fat || 0);
                    updateUI();
                    renderThinking(`<b>AI åˆ†æå»ºè­°ï¼š</b><br>${result.advice || "åˆ†æå®Œæˆï¼Œè³‡æ–™å·²åŒæ­¥ã€‚"}`);
                } else {
                    renderThinking(`<b>AI å›æ‡‰ï¼š</b><br>${text || "åˆ†æå®Œæˆï¼Œä½†æ ¼å¼é JSONï¼Œå·²è¨˜éŒ„ã€‚"}`);
                }
                await saveDailyData();
                resetInputs();
            } catch (e) { 
                console.error(e); 
                renderThinking(`<span class="text-red-400 font-bold">âŒ åˆ†æå¤±æ•—ï¼š</span><br>${e.message}`);
            }
            finally { showLoading(false); }
        }

        function updateUI() {
            const { consumed, targets } = currentDayData;
            document.getElementById('cal-remaining').textContent = Math.max(0, Math.round(targets.cal - consumed.cal));
            document.getElementById('pro-label').textContent = `${Math.round(consumed.pro)}/${targets.pro}g`;
            document.getElementById('carb-label').textContent = `${Math.round(consumed.carb)}/${targets.carb}g`;
            document.getElementById('fat-label').textContent = `${Math.round(consumed.fat)}/${targets.fat}g`;

            document.getElementById('pro-bar').style.width = `${Math.min(100, (consumed.pro/targets.pro)*100)}%`;
            document.getElementById('carb-bar').style.width = `${Math.min(100, (consumed.carb/targets.carb)*100)}%`;
            document.getElementById('fat-bar').style.width = `${Math.min(100, (consumed.fat/targets.fat)*100)}%`;

            const ctx = document.getElementById('calChart').getContext('2d');
            if (calChart) calChart.destroy();
            calChart = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [consumed.cal, Math.max(0, targets.cal - consumed.cal)], backgroundColor: ['#10b981', '#1e293b'], borderWidth: 0 }] },
                options: { cutout: '85%', plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false }
            });
        }

        function renderThinking(text) {
            const div = document.createElement('div');
            div.className = "p-4 bg-slate-800/60 border border-slate-700 rounded-xl mb-3 text-slate-300 animate-fade-in text-xs leading-relaxed";
            div.innerHTML = text;
            document.getElementById('ai-content').prepend(div);
        }

        function resetInputs() {
            document.getElementById('meal-text-input').value = "";
            document.getElementById('manual-cal').value = "";
            document.getElementById('manual-pro').value = "";
            document.getElementById('manual-carb').value = "";
            document.getElementById('manual-fat').value = "";
            document.getElementById('food-img').value = "";
            document.getElementById('meal-file').value = "";
            document.getElementById('preview-img').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
        }

        function showLoading(show, text = "") {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
            document.getElementById('loading-text').textContent = text;
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('target-date').valueAsDate = new Date();
            document.getElementById('food-img').onchange = function(evt) {
                const [file] = evt.target.files;
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('preview-img').src = e.target.result;
                        document.getElementById('preview-img').classList.remove('hidden');
                        document.getElementById('upload-placeholder').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            };
        });
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    
    <div class="max-w-6xl mx-auto space-y-6">
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 glass-card p-6">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-400 font-serif">HealthMind Dashboard</h1>
                <p class="text-slate-400 text-sm mt-1 uppercase tracking-widest text-[10px]">ç¶œåˆæ•¸æ“šç®¡ç† (æ”¯æ´æœ¬åœ°èˆ‡é›²ç«¯å¤šé¸)</p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <input type="date" id="target-date" class="bg-slate-800 border-slate-700 text-white p-2 rounded-lg text-sm" onchange="if(accessToken) loadDailyData()">
                <button id="auth-btn" onclick="handleAuthClick()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-sm font-semibold transition shadow-lg">
                    <i class="fab fa-google mr-1"></i> é€£çµ Google
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <!-- è„ˆçµ¡ç®¡ç†å€ -->
                <section class="glass-card p-6">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="fas fa-file-import text-cyan-400"></i> è„ˆçµ¡æ•´åˆ (æ”¯æ´å¤šé¸)</h2>
                    <div class="space-y-4">
                        <!-- é£²é£Ÿè¨ˆç•« -->
                        <div class="space-y-1">
                            <span class="text-[10px] text-slate-500 font-bold uppercase">é£²é£Ÿè¨ˆç•«èˆ‡åŸå‰‡</span>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="createPicker('plan')" class="bg-slate-800 hover:bg-slate-700 p-2 rounded text-[10px] border border-slate-700 transition">é›²ç«¯é¸å–</button>
                                <button onclick="triggerLocalFile('plan')" class="bg-slate-800 hover:bg-slate-700 p-2 rounded text-[10px] border border-slate-700 transition">æœ¬åœ°ä¸Šå‚³</button>
                            </div>
                        </div>
                        <!-- æ­·å²ç´€éŒ„ -->
                        <div class="space-y-1">
                            <span class="text-[10px] text-slate-500 font-bold uppercase">ä»¥å‰ç´€éŒ„ (PDF/Doc)</span>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="createPicker('history')" class="bg-slate-800 hover:bg-slate-700 p-2 rounded text-[10px] border border-slate-700 transition">é›²ç«¯é¸å–</button>
                                <button onclick="triggerLocalFile('history')" class="bg-slate-800 hover:bg-slate-700 p-2 rounded text-[10px] border border-slate-700 transition">æœ¬åœ°ä¸Šå‚³</button>
                            </div>
                        </div>
                        <div id="selected-contexts" class="space-y-2"></div>
                    </div>
                </section>

                <!-- æ”å–ç´€éŒ„åˆ†æ -->
                <section class="glass-card p-6 border-emerald-500/20 bg-emerald-500/5">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="fas fa-utensils text-orange-400"></i> æœ¬æ¬¡æ”å–ç´€éŒ„</h2>
                    <div class="space-y-4">
                        <!-- ç…§ç‰‡ä¸Šå‚³ -->
                        <div class="border-2 border-dashed border-slate-700 rounded-xl p-4 text-center relative cursor-pointer hover:border-emerald-500/50 transition bg-slate-900/50">
                            <input type="file" id="food-img" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                            <div id="upload-placeholder"><i class="fas fa-camera text-xl text-slate-500 mb-1"></i><p class="text-[10px] text-slate-400">æ‹æ”ç…§ç‰‡åˆ†æ</p></div>
                            <img id="preview-img" class="hidden w-full h-24 object-cover rounded-lg">
                        </div>
                        
                        <!-- æª”æ¡ˆæè¿° -->
                        <div class="space-y-2">
                            <label class="text-[10px] text-slate-500 font-bold uppercase">é£²é£Ÿæè¿°æª”æ¡ˆ/æ–‡å­—</label>
                            <input type="file" id="meal-file" class="w-full bg-slate-800 text-[9px] p-1.5 rounded border border-slate-700 mb-2">
                            <textarea id="meal-text-input" rows="2" placeholder="åœ¨æ­¤è¼¸å…¥é£²é£Ÿèªªæ˜ (ä¾‹å¦‚ï¼šæˆ‘åƒäº†ä¸‰å€‹æ°´é¤ƒ)..." class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-[10px] outline-none"></textarea>
                        </div>

                        <!-- æ•¸å€¼ç¶²æ ¼ -->
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-[8px] text-slate-500 block">ç†±é‡(kcal)</label><input type="number" id="manual-cal" class="w-full bg-slate-800 text-xs p-1.5 rounded"></div>
                            <div><label class="text-[8px] text-slate-500 block">è›‹ç™½(g)</label><input type="number" id="manual-pro" class="w-full bg-slate-800 text-xs p-1.5 rounded"></div>
                            <div><label class="text-[8px] text-slate-500 block">ç¢³æ°´(g)</label><input type="number" id="manual-carb" class="w-full bg-slate-800 text-xs p-1.5 rounded"></div>
                            <div><label class="text-[8px] text-slate-500 block">è„‚è‚ª(g)</label><input type="number" id="manual-fat" class="w-full bg-slate-800 text-xs p-1.5 rounded"></div>
                        </div>
                        
                        <button onclick="processIntake()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-bold text-xs transition shadow-lg">åŒæ­¥åˆ†æçµæœ</button>
                    </div>
                </section>
            </div>

            <!-- å³å´æ•¸æ“šé¡¯ç¤º -->
            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-6 flex flex-col items-center">
                        <h3 class="text-xs text-slate-400 mb-4 w-full uppercase tracking-wider text-center font-bold">ä»Šæ—¥ç†±é‡æ¶ˆè€—é€²åº¦</h3>
                        <div class="relative w-44 h-44"><canvas id="calChart"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"><span class="text-2xl font-bold" id="cal-remaining">0</span><span class="text-[9px] text-slate-500 uppercase">å‰©é¤˜å¤§å¡</span></div></div>
                    </div>
                    <div class="glass-card p-6 space-y-4">
                        <h3 class="text-xs text-slate-400 uppercase tracking-wider font-bold">ç‡Ÿé¤Šç›®æ¨™é”æˆç‡</h3>
                        <div class="space-y-4">
                            <div><div class="flex justify-between text-[10px] mb-1"><span>è›‹ç™½è³ª</span><span id="pro-label">0/120g</span></div><div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden"><div id="pro-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: 0%"></div></div></div>
                            <div><div class="flex justify-between text-[10px] mb-1"><span>ç¢³æ°´åŒ–åˆç‰©</span><span id="carb-label">0/150g</span></div><div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden"><div id="carb-bar" class="h-full bg-emerald-500 rounded-full transition-all duration-500" style="width: 0%"></div></div></div>
                            <div><div class="flex justify-between text-[10px] mb-1"><span>è„‚è‚ª</span><span id="fat-label">0/60g</span></div><div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden"><div id="fat-bar" class="h-full bg-orange-500 rounded-full transition-all duration-500" style="width: 0%"></div></div></div>
                        </div>
                    </div>
                </div>
                <section class="glass-card p-6 min-h-[220px]">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 font-serif"><i class="fas fa-brain text-purple-400"></i> AI æ·±åº¦æ€è€ƒåˆ†æå»ºè­°</h2>
                    <div id="ai-content" class="text-xs italic text-slate-500 leading-relaxed">è«‹ç¢ºèªå·²å¡«å¯« API_KEY ä¸¦é€£çµ Google å¸³è™Ÿã€‚</div>
                </section>
            </div>
        </div>
    </div>
    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md z-[100] hidden flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
        <p id="loading-text" class="mt-4 text-emerald-400 text-xs font-medium"></p>
    </div>
</body>
</html>